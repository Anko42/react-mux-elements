import h from"mux-embed";import M from"hls.js";var m=class extends Error{constructor(r,n=m.MEDIA_ERR_CUSTOM,o){var a;super(r);this.name="MediaError",this.code=n,this.fatal=o!=null?o:n>=m.MEDIA_ERR_NETWORK&&n<=m.MEDIA_ERR_ENCRYPTED,this.message||(this.message=(a=m.defaultMessages[this.code])!=null?a:"")}},l=m;l.MEDIA_ERR_ABORTED=1,l.MEDIA_ERR_NETWORK=2,l.MEDIA_ERR_DECODE=3,l.MEDIA_ERR_SRC_NOT_SUPPORTED=4,l.MEDIA_ERR_ENCRYPTED=5,l.MEDIA_ERR_CUSTOM=100,l.defaultMessages={1:"You aborted the media playback",2:"A network error caused the media download to fail.",3:"A media error caused playback to be aborted. The media could be corrupt or your browser does not support this format.",4:"An unsupported error occurred. The server or network failed, or your browser does not support this format.",5:"The media is encrypted and there are no keys to decrypt it."};import H from"hls.js";var k=(e,t)=>e in t,v={ANY:"any",MUTED:"muted"},x={VOD:"on-demand",ON_DEMAND:"on-demand",LIVE:"live",LL_LIVE:"ll-live",DVR:"live:dvr",LL_DVR:"ll-live:dvr"},_={MSE:"mse",NATIVE:"native"},L={HEADER:"header",QUERY:"query",NONE:"none"},pe=Object.values(L),f={M3U8:"application/vnd.apple.mpegurl",MP4:"video/mp4"},b={HLS:f.M3U8},ye=Object.keys(b),fe=[...Object.values(f),"hls","HLS"];var T=(e,t,r,n)=>{e.addEventListener(t,r,n),e.addEventListener("teardown",()=>{e.removeEventListener(t,r)},{once:!0})};function S(e,t,r){t&&r>t&&(r=t);for(let n=0;n<e.length;n++)if(e.start(n)<=r&&e.end(n)>=r)return!0;return!1}var C=e=>{let t=e.indexOf("?");if(t<0)return[e];let r=e.slice(0,t),n=e.slice(t);return[r,n]},A=e=>{let t=e.type;if(t){let n=t.toUpperCase();return k(n,b)?b[n]:t}let{src:r}=e;return r?G(r):""},G=e=>{let t="";try{t=new URL(e).pathname}catch{console.error("invalid url")}let r=t.lastIndexOf(".");if(r<0)return"";let o=t.slice(r+1).toUpperCase();return k(o,f)?f[o]:""};var J=Object.values(v),w=e=>typeof e=="boolean"||typeof e=="string"&&J.includes(e),O=({autoplay:e},t,r)=>{let n=!1,o=!1,a=w(e)?e:!!e,i=()=>{n||T(t,"playing",()=>{n=!0},{once:!0})};if(i(),T(t,"loadstart",()=>{n=!1,i(),R(t,a)},{once:!0}),T(t,"loadstart",()=>{r||(o=!Number.isFinite(t.duration)),R(t,a)},{once:!0}),r&&r.once(H.Events.LEVEL_LOADED,(c,d)=>{var u;o=(u=d.details.live)!=null?u:!1}),!a){let c=()=>{!o||(r!=null&&r.liveSyncPosition?t.currentTime=r.liveSyncPosition:Number.isFinite(t.seekable.end(0))&&(t.currentTime=t.seekable.end(0)))};r&&T(t,"play",()=>{t.preload==="metadata"?r.once(H.Events.LEVEL_UPDATED,c):c()},{once:!0})}return c=>{n||(a=w(c)?c:!!c,R(t,a))}},R=(e,t)=>{if(!t)return;let r=e.muted,n=()=>e.muted=r;switch(t){case v.ANY:e.play().catch(()=>{e.muted=!0,e.play().catch(n)});break;case v.MUTED:e.muted=!0,e.play().catch(n);break;default:e.play().catch(()=>{});break}};var N=({preload:e,src:t},r,n)=>{let o=p=>{p!=null&&["","none","metadata","auto"].includes(p)?r.setAttribute("preload",p):r.removeAttribute("preload")};if(!n)return o(e),o;let a=!1,i=!1,s=n.config.maxBufferLength,c=n.config.maxBufferSize,d=p=>{o(p);let y=p!=null?p:r.preload;i||y==="none"||(y==="metadata"?(n.config.maxBufferLength=1,n.config.maxBufferSize=1):(n.config.maxBufferLength=s,n.config.maxBufferSize=c),u())},u=()=>{!a&&t&&(a=!0,n.loadSource(t))};return T(r,"play",()=>{i=!0,n.config.maxBufferLength=s,n.config.maxBufferSize=c,u()},{once:!0}),d(e),d};import g from"hls.js";function V(e,t){t.on(g.Events.NON_NATIVE_TEXT_TRACKS_FOUND,(o,{tracks:a})=>{a.forEach(i=>{var d;let s=(d=i.subtitleTrack)!=null?d:i.closedCaptions,c=t.subtitleTracks.findIndex(({lang:u,name:p,type:y})=>u==(s==null?void 0:s.lang)&&p===i.label&&y.toLowerCase()===i.kind);U(e,i.kind,i.label,s==null?void 0:s.lang,`${i.kind}${c}`)})});let r=()=>{var i;if(!t.subtitleTracks.length)return;let o=Array.from(e.textTracks).find(s=>s.id&&s.mode==="showing"&&["subtitles","captions"].includes(s.kind)),a=`${(i=t.subtitleTracks[t.subtitleTrack])==null?void 0:i.type.toLowerCase()}${t.subtitleTrack}`;if(o&&(t.subtitleTrack<0||(o==null?void 0:o.id)!==a)){let s=t.subtitleTracks.findIndex(({lang:c,name:d,type:u})=>c==o.language&&d===o.label&&u.toLowerCase()===o.kind);t.subtitleTrack=s}o&&(o==null?void 0:o.id)===a&&o.cues&&Array.from(o.cues).forEach(s=>{o.addCue(s)})};e.textTracks.addEventListener("change",r),t.on(g.Events.CUES_PARSED,(o,{track:a,cues:i})=>{let s=e.textTracks.getTrackById(a);if(!s)return;let c=s.mode==="disabled";c&&(s.mode="hidden"),i.forEach(d=>{var u;(u=s.cues)!=null&&u.getCueById(d.id)||s.addCue(d)}),c&&(s.mode="disabled")}),t.once(g.Events.DESTROYING,()=>{e.textTracks.removeEventListener("change",r),e.querySelectorAll("track[data-removeondestroy]").forEach(a=>{a.remove()})});let n=()=>{Array.from(e.textTracks).forEach(o=>{var a,i;if(!["subtitles","caption"].includes(o.kind)&&o.label==="thumbnails"){if(!((a=o.cues)!=null&&a.length)){let s=e.querySelector('track[label="thumbnails"]'),c=(i=s==null?void 0:s.getAttribute("src"))!=null?i:"";s==null||s.removeAttribute("src"),setTimeout(()=>{s==null||s.setAttribute("src",c)},0)}o.mode!=="hidden"&&(o.mode="hidden")}})};t.once(g.Events.MANIFEST_LOADED,n),t.once(g.Events.MEDIA_ATTACHED,n)}function U(e,t,r,n,o){let a=document.createElement("track");return a.kind=t,a.label=r,n&&(a.srclang=n),o&&(a.id=o),a.track.mode="disabled",a.setAttribute("data-removeondestroy",""),e.append(a),a.track}function Z(e,t){let r=Array.prototype.find.call(e.querySelectorAll("track"),n=>n.track===t);r==null||r.remove()}var K,B,j=(B=(K=globalThis==null?void 0:globalThis.navigator)==null?void 0:K.userAgent)!=null?B:"",ee=j.toLowerCase().indexOf("android")!==-1,E=new WeakMap,Y="mux.com",F,q,W=(q=(F=M).isSupported)==null?void 0:q.call(F),te=ee,Ve=()=>h.utils.now(),re=h.utils.generateUUID,Ue=(e,{domain:t=Y}={})=>{if(!e)return;let[r,n=""]=C(e);return`https://stream.${t}/${r}.m3u8${n}`},ne=e=>{if(!e)return;let[t]=e.split("?");return t||void 0},oe=e=>{if(!e||!e.startsWith("https://stream."))return;let[t]=new URL(e).pathname.slice(1).split(".m3u8");return t||void 0},ae=e=>{var t,r,n;return(t=e==null?void 0:e.metadata)!=null&&t.video_id?e.metadata.video_id:$(e)&&(n=(r=ne(e.playbackId))!=null?r:oe(e.src))!=null?n:e.src},Ke=e=>{var t;return(t=E.get(e))==null?void 0:t.error},Be=(e,t,r)=>{se(t,r);let{metadata:n={}}=e,{view_session_id:o=re()}=n,a=ae(e);n.view_session_id=o,n.video_id=a,e.metadata=n,E.set(t,{});let i=ie(e,t);de(e,t,i),ue(e,t,i);let s=O(e,t,i),c=N(e,t,i);return{engine:i,setAutoplay:s,setPreload:c}},se=(e,t)=>{let r=t==null?void 0:t.engine;r&&(r.detachMedia(),r.destroy()),(e==null?void 0:e.mux)&&!e.mux.deleted&&(e.mux.destroy(),delete e.mux),e&&(e.removeAttribute("src"),e.load(),e.removeEventListener("error",X),e.removeEventListener("error",D),e.removeEventListener("durationchange",Q),E.delete(e),e.dispatchEvent(new Event("teardown")))};function z(e,t){var d;let r=A(e);if(!(r===f.M3U8))return!0;let o=!r||((d=t.canPlayType(r))!=null?d:!0),{preferPlayback:a}=e,i=a===_.MSE,s=a===_.NATIVE;return o&&(s||!(W&&(i||te)))}var ie=(e,t)=>{let{debug:r,streamType:n,startTime:o=-1,metadata:a,preferCmcd:i}=e,c=A(e)===f.M3U8,d=z(e,t);if(c&&!d&&W){let u={backBufferLength:30,renderTextTracksNatively:!1,liveDurationInfinity:!0},p=ce(n),y=i!==L.NONE?{useHeaders:i===L.HEADER,sessionId:a.view_session_id,contentId:a.video_id}:void 0;return new M({debug:r,startPosition:o,cmcd:y,...u,...p})}},ce=e=>[x.LIVE,x.DVR].includes(e)?{backBufferLength:8}:[x.LL_LIVE,x.LL_DVR].includes(e)?{backBufferLength:4,maxFragLookUpTolerance:.001}:{},$=({playbackId:e,src:t,customDomain:r})=>{if(e)return!0;if(typeof t!="string")return!1;let n=window==null?void 0:window.location.href,o=new URL(t,n).hostname.toLocaleLowerCase();return o.includes(Y)||!!r&&o.includes(r.toLocaleLowerCase())},de=(e,t,r)=>{var a;let{envKey:n}=e,o=$(e);if(n||o){let{playerInitTime:i,playerSoftwareName:s,playerSoftwareVersion:c,beaconCollectionDomain:d,debug:u,disableCookies:p}=e,y={...e.metadata,video_title:((a=e==null?void 0:e.metadata)==null?void 0:a.video_title)||void 0},I=P=>typeof P.player_error_code=="string"?!1:typeof e.errorTranslator=="function"?e.errorTranslator(P):P;h.monitor(t,{debug:u,beaconCollectionDomain:d,hlsjs:r,Hls:r?M:void 0,automaticErrorTracking:!1,errorTranslator:I,disableCookies:p,data:{...n?{env_key:n}:{},player_software_name:s,player_software:s,player_software_version:c,player_init_time:i,...y}})}},ue=(e,t,r)=>{var a;let n=z(e,t),{src:o}=e;t&&n?(typeof o=="string"?(t.setAttribute("src",o),e.startTime&&(((a=E.get(t))!=null?a:{}).startTime=e.startTime,t.addEventListener("durationchange",Q,{once:!0}))):t.removeAttribute("src"),t.addEventListener("error",X),t.addEventListener("error",D)):r&&o?(r.on(M.Events.ERROR,(i,s)=>{let c={[M.ErrorTypes.NETWORK_ERROR]:l.MEDIA_ERR_NETWORK,[M.ErrorTypes.MEDIA_ERROR]:l.MEDIA_ERR_DECODE},d=new l("",c[s.type]);d.fatal=s.fatal,d.data=s,t.dispatchEvent(new CustomEvent("error",{detail:d}))}),t.addEventListener("error",D),V(t,r),r.attachMedia(t)):console.error("It looks like the video you're trying to play will not work on this system! If possible, try upgrading to the newest versions of your browser or software.")};function Q(e){var n;let t=e.target,r=(n=E.get(t))==null?void 0:n.startTime;if(!!r&&S(t.seekable,t.duration,r)){let o=t.preload==="auto";o&&(t.preload="none"),t.currentTime=r,o&&(t.preload="auto")}}async function X(e){if(!e.isTrusted)return;e.stopImmediatePropagation();let t=e.target;if(!(t!=null&&t.error))return;let{message:r,code:n}=t.error,o=new l(r,n);if(t.src&&(n!==l.MEDIA_ERR_DECODE||n!==void 0))try{let{status:a}=await fetch(t.src);o.data={response:{code:a}}}catch{}t.dispatchEvent(new CustomEvent("error",{detail:o}))}function D(e){var n,o;if(!(e instanceof CustomEvent)||!(e.detail instanceof l))return;let t=e.target,r=e.detail;!r||!r.fatal||(((n=E.get(t))!=null?n:{}).error=r,(o=t.mux)==null||o.emit("error",{player_error_code:r.code,player_error_message:r.message}))}export{v as AutoplayTypes,pe as CmcdTypeValues,L as CmcdTypes,f as ExtensionMimeTypeMap,M as Hls,l as MediaError,b as MimeTypeShorthandMap,_ as PlaybackTypes,x as StreamTypes,U as addTextTrack,fe as allMediaTypes,Ve as generatePlayerInitTime,re as generateUUID,Ke as getError,ce as getStreamTypeConfig,Be as initialize,k as isKeyOf,$ as isMuxVideoSrc,ue as loadMedia,h as mux,Z as removeTextTrack,ie as setupHls,de as setupMux,ye as shorthandKeys,se as teardown,Ue as toMuxVideoURL};
//# sourceMappingURL=index.mjs.map
